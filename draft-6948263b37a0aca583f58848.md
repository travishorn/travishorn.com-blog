---
title: "Galera"
slug: galera

---

TODO: Introduction. Let’s experiment with database replication with MariaDB and Galera Cluster.

For this lab, I’m using VirtualBox. The cluster will consist of 3 nodes so we’ll set up 3 virtual machines.

## Create Host-only Network Adapter

1. Open VirtualBox
    
2. File &gt; Tools &gt; Network Manager
    
3. Host-only Networks tab: Note the name of the host-only network. If one doesn’t exist…
    
4. Click Create
    
5. Under Properties &gt; Adapter tab &gt; Select Configure Adapter Manually
    
6. IPv4 Address: 192.168.56.1
    
7. IPv4 Network Mask: 255.255.255.0
    
8. Click Apply
    

## Create the first node, “galera-alpha”

1. In VirtualBox &gt; Machine &gt; New
    
2. Name: galera-alpha. Note: You can name these machines anything you want. I’m going with galera-alpha, -beta, and -gamma.
    
3. ISO Image: Download and select the latest Debian ISO image. Using 13.2.0 as of this writing
    
4. Check “Skip Unattended Installation”
    
5. Hardware &gt; Base Memory: 6144 MB (but all the way down to 2048 MB is probably okay)
    
6. Processors: 2 (but down to 1 is probably okay)
    
7. Hard Disk: 20 GB (but down to 8 GB is probably okay)
    
8. Before powering on, right-click the machine and choose Settings
    
9. Go to the Network section
    
10. Adapter 1 tab: Attached to: NAT
    
11. Adapter 2 tab: Check Enable Network Adapter
    
12. Attached to: Host-only Adapter
    
13. Name: Choose the one we created earlier
    
14. Power the virtual machine on
    
15. Follow the Debian installer, choosing the default or whichever options make sense for you
    
    1. When choosing the primary network interface, select the first one, which is usually enp0s3
        
    2. Hostname: galera-alpha
        
    3. Domain name: local (or anything you want, as long as all nodes we will create match)
        
    4. Software selection: Uncheck Debian desktop environment and GNOME
        
    5. Check SSH server and standard system utilities
        
16. Once the operating system is fully installed, power off the virtual machine
    

## Create the other two nodes, “galera-beta” and “galera-gamma”

1. In VirtualBox, right-click galera-alpha &gt; Clone
    
2. Name: galera-beta
    
3. MAC Address Policty: Generate new MAC addresses for all network adapters
    
4. Repeat for galera-gamma
    

## Configure the nodes

1. Start all three virtual machines
    
2. Log in as root
    
3. On galera-beta, run hostnamectl set-hostname galera-beta
    
4. On galera-gamma, run hostnamectl set-hostname galera-gamma
    
5. Edit /etc/network/interfaces. Add the configuration for the second interface (usually enp0s8)
    

```bash
# On galera-alpha
allow-hotplug enp0s8
iface enp0s8 inet static
    address 192.168.56.101
    netmask 255.255.255.0

# On galera-beta
allow-hotplug enp0s8
iface enp0s8 inet static
    address 192.168.56.102
    netmask 255.255.255.0

# On galera-gamma
allow-hotplug enp0s8
iface enp0s8 inet static
    address 192.168.56.103
    netmask 255.255.255.0
```

6. Restart networking: `systemctl restart networking`
    
7. Edit `/etc/hosts` on all three. Add to the bottom:
    

```bash
192.168.56.101 galera-alpha
192.168.56.102 galera-beta
192.168.56.103 galera-gamma
```

8. Install MariaDB and rsync on all three: `apt install -y mariadb-server rsync`
    

## Configure MariaDB for Galera Cluster

Edit `/etc/mysql/mariadb.conf.d/60-galera.cnf`. Make sure these settings are set on all three nodes

```bash
wsrep_on = ON
wsrep_cluster_name = "GaleraCluster" # Give it any name you want
wsrep_cluster_address = "gcomm://192.168.56.101,192.168.56.102,192.168.56.103"
binlog_format = row
default_storage_engine = InnoDB
innodb_autoinc_lock_mode = 2

bind-address = 0.0.0.0

wsrep_provider = /usr/lib/libgalera_smm.so
wsrep_sst_method = rsync

# On galera-alpha only
wsrep_node_address = 192.168.56.101
wsrep_node_name = galera-alpha

# On galera-beta only
wsrep_node_address = 192.168.56.102
wsrep_node_name = galera-beta

# On galera-gamma only
wsrep_node_address = 192.168.56.103
wsrep_node_name = galera-gamma
```

## Bootstrap the Cluster

This section is done on galera-alpha only.

1. Stop MariaDB: `systemctl stop mariadb`
    
2. Bootstrap the cluster: `galera_new_cluster`
    
3. Log into MariaDB: `mariadb`
    
4. Check the size of the cluster: `SHOW STATUS LIKE ‘wsrep_cluster_size’;`
    

It should say `1`. If it says `0`, something has gone wrong. You can check MariaDB’s status using systemctl and/or the logs with journalctl.

## Join the other nodes

1. On galera-beta and galera-gamma, just restart MariaDB: `systemctl restart mariadb`.
    
2. Verify the cluster size on any machine
    
    1. Log into MariaDB: `mariadb`
        
    2. Check the size of the cluster `SHOW STATUS LIKE ‘wsrep_cluster_size’;`
        

It should say `3` now.

## Test it out

Create databases, users, and tables. Insert, update, and delete rows. Everything should be synced up between all nodes.

## A simple Node.js test app

### Database Setup

1. Log into MariaDB and create a new database: `CREATE DATABASE cluster_app;`
    
2. Use the newly created database: `USE cluster_app;`
    
3. Create a table: `CREATE TABLE visits (id uuid NOT NULL DEFAULT uuid_v7(), node_name varchar(50) DEFAULT NULL, PRIMARY KEY (id));`
    
4. Create a dedicated user: `CREATE USER ‘cluster_app_user'@'%' IDENTIFIED BY 'a strong password';`
    
5. Grant privileges: `GRANT ALL PRIVILEGES ON cluster_app.* TO ‘cluster_app_user’@’%’;`
    
6. Flush privileges: `FLUSH PRIVILEGES;`
    

### Application code

1. On galera-alpha, install Node.js and npm: `apt install -y nodejs npm`  
    In a real setting, this would actually probably be on a separate server machine. But for this experiment, you can just run it on galera-alpha.
    
2. Create a new directory for the app: `mkdir cluster-app`
    
3. Change into the directory: `cd cluster-app`
    
4. Initialize a new npm package: `npm init -y`
    
5. Install the official MariaDB driver: `npm install mariadb`
    

Now create `index.js` with the following content.

```javascript
const mariadb = require('mariadb');

const DB_CREDENTIALS = {
  user: 'cluster_app_user',
  password: 'a strong password',
  database: 'cluster_app',
  connectionLimit: 5
};

const CLUSTER_NODES = [
  { id: 'galera-alpha', host: '192.168.56.101' },
  { id: 'galera-beta',  host: '192.168.56.102' },
  { id: 'galera-gamma', host: '192.168.56.103' }
];

const CHECK_INTERVAL_MS = 2000;

// Initialize the PoolCluster.
const cluster = mariadb.createPoolCluster();

// Add nodes to the cluster configuration
CLUSTER_NODES.forEach(node => {
  cluster.add(node.id, { host: node.host, ...DB_CREDENTIALS });
  console.log(`Added node to pool: ${node.id} (${node.host})`);
});

async function performHealthCheck() {
  let conn;

  try {
    // Get a connection from a random node in the cluster
    // `null` here means to consider all nodes for the connection
    // `'RANDOM'` tells the connection to choose a random node
    conn = await cluster.getConnection(null, 'RANDOM');

    // Identify which physical server we are connected to
    const hostnameRes = await conn.query("SELECT @@HOSTNAME AS server_id;");
    const serverName = hostnameRes[0].server_id;
    
    // Perform a Write Operation
    const insertRes = await conn.query(
      "INSERT INTO visits (node_name) VALUES (?) RETURNING id;", 
      [serverName]
    );

    // Log success
    console.log(`Success on node: ${serverName} | ID: ${insertRes[0].id}`);

    // Perform a Read Operation
    const recentRes = await conn.query(
      "SELECT id, node_name FROM visits ORDER BY id DESC LIMIT 3;"
    );

    // Log recent visits
    console.log(recentRes);
  } catch (err) {
    console.error(`Connection Error:`, err.message);
  } finally {
    if (conn) conn.release();
  }
}

// Perform the health check every interval (2000ms)
const intervalId = setInterval(performHealthCheck, CHECK_INTERVAL_MS);
```

Run the script with `node index.js`. It connects to the cluster and starts performing a health check every 2 seconds. The health check consists of a write and then a read operation. You can let this script run for as long as you want. You should see output like this:

```bash
Added node to pool: galera-alpha (192.168.56.101)
Added node to pool: galera-beta (192.168.56.102)
Added node to pool: galera-gamma (192.168.56.103)
Success on node: galera-alpha | ID: 019b4b82-1d95-7464-8da8-cf72905a0f09
[
  {
    id: '019b4b82-1d95-7464-8da8-cf72905a0f09',
    node_name: 'galera-alpha'
  },
  {
    id: '019b4b80-c7a9-7844-9710-d69a9ca30855',
    node_name: 'galera-beta'
  },
  {
    id: '019b4b80-bfd9-76c8-9146-77531b6ec8d7',
    node_name: 'galera-gamma'
  }
]
Success on node: galera-beta | ID: 019b4b82-27ba-71d8-b94f-f9b06e0534d6
[
  {
    id: '019b4b82-27ba-71d8-b94f-f9b06e0534d6',
    node_name: 'galera-beta'
  },
  {
    id: '019b4b82-1d95-7464-8da8-cf72905a0f09',
    node_name: 'galera-alpha'
  },
  {
    id: '019b4b80-c7a9-7844-9710-d69a9ca30855',
    node_name: 'galera-beta'
  }
]
```

TODO: What does this tell us? What have we accomplished?

TODO: General conclusion. What is this type of setup used for? Why is this cool?